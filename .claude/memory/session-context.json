{
  "framework_decisions": {
    "ui_library": "Tabler UI (@tabler/core)",
    "ui_icons": "@tabler/icons-react",
    "backend_framework": "Express.js",
    "database": "MongoDB (native driver)",
    "frontend_state": "Custom hooks + React Context",
    "table_library": "TanStack Table v8",
    "charts": "Highcharts",
    "i18n": "i18next + react-i18next",
    "routing": "React Router v7",
    "build_tool": "Vite",
    "email_service": "AWS SES (for transactional emails)"
  },
  "architecture_patterns": {
    "api_structure": "Vercel serverless functions (api/) + Express dev server (server/)",
    "auth_pattern": "JWT tokens (lib/jwt.js) + middleware (lib/middleware.js)",
    "password_reset": "Email-based flow with AWS SES (lib/email.js) + rate limiting (lib/rate-limit.js)",
    "permission_filtering": "Use lib/filter-permissions.js (getAccessibleCountries, getAccessibleSurveys, getAccessibleDistricts, applyDownloadPermissions)",
    "mongodb_collections": "Dynamic naming: surveys_flags-{asset_id}, enumerators_stats-{asset_id}; Static: users, surveys, countries, districts; Infrastructure: sync_audit_log, system_locks",
    "error_responses": "Use lib/response.js helpers (sendSuccess, sendError, sendBadRequest, setCorsHeaders)",
    "validation": "Use lib/helpers.js (validateObjectId, sanitizeCSV, etc.)",
    "data_flow": "KoboToolbox → R Pipeline → MongoDB → Portal (MongoDB as single source of truth)",
    "airtable_sync": "Production-hardened sync infrastructure (8/10 readiness): field mapping config (config/airtable-field-mappings.json), pre-sync schema validation, transaction-like safety (lib/sync-transaction.js), audit logging (lib/sync-audit-logger.js), rate limiting (lib/airtable-rate-limiter.js), distributed locks (lib/sync-lock.js), automated cron (vercel.json), webhook support (api/webhooks/airtable-sync.js)"
  },
  "external_services": {
    "kobo_toolbox": "Survey data collection (per-survey configuration in surveys.kobo_config)",
    "airtable": "Centralized data source for users, surveys, districts (sync via scripts/sync_*_from_airtable.js - not runtime dependency)",
    "r_pipeline": "External data processing (fetches from KoboToolbox, calculates alerts, writes to MongoDB)",
    "aws_ses": "Transactional email delivery (password reset emails, multi-language support)",
    "peskas_api": "Landings data download (api.peskas.org) with X-API-Key auth, input validation, rate limiting (lib/peskas-api.js)"
  },
  "current_session": {
    "last_feature": "PeSKAS API Metadata Integration for Enhanced Field Documentation",
    "active_files": [
      "api/data-download/metadata-fields.js",
      "lib/peskas-api.js",
      "server/dev.js",
      "src/types/download.ts",
      "src/api/api.ts",
      "src/components/DataDownload/FieldInfoIcon.tsx",
      "src/components/DataDownload/FieldMetadataModal.tsx",
      "src/components/DataDownload/DataPreview.tsx",
      "public/locales/en/download.json",
      "public/locales/pt/download.json",
      "public/locales/sw/download.json"
    ],
    "completed_improvements": [
      "✅ Performance Optimization: 90-95% load time reduction (30-60s → 2-3s for admins)",
      "✅ Phase 1: Database indexes created (10s → 0.5s per query, 90% improvement)",
      "✅ Phase 1: Survey-based loading (prevents loading ALL surveys simultaneously)",
      "✅ Phase 1: MongoDB-level limits (500MB → 5MB memory, 99% reduction)",
      "✅ Phase 2: Batched alert codes (10 API calls → 1, 90% reduction)",
      "✅ Phase 2: Optimistic status updates (2-3s → 200ms, 93% reduction)",
      "✅ Phase 3: Memoization in EnumeratorPerformance (500ms → 100ms, 80% reduction)",
      "✅ Phase 3: React.memo for 7 chart components (10-20 → 1-2 re-renders, 90% reduction)",
      "✅ Data transfer reduced by 99% (50MB → 500KB)",
      "✅ Backward compatibility maintained (supports old limit=100000 with warnings)",
      "✅ Comprehensive documentation (PERFORMANCE_IMPROVEMENTS.md + architecture-decisions.md)",
      "✅ Airtable Integration Production Readiness: 3/10 → 8/10",
      "✅ Centralized field mapping configuration (config/airtable-field-mappings.json)",
      "✅ Pre-sync schema validation (detects renamed Airtable columns)",
      "✅ Transaction-like safety with checkpoint/rollback (lib/sync-transaction.js)",
      "✅ Code consolidation: 3 implementations → 1 canonical (44% code reduction)",
      "✅ Persistent audit logging to MongoDB (lib/sync-audit-logger.js with uuid)",
      "✅ Airtable API rate limiting with exponential backoff (lib/airtable-rate-limiter.js)",
      "✅ Distributed locks preventing concurrent syncs (lib/sync-lock.js)",
      "✅ Dependency order enforcement: Districts → Surveys → Users",
      "✅ Automated daily syncs via Vercel cron (2 AM UTC)",
      "✅ Webhook support for real-time Airtable sync triggers",
      "✅ Admin API endpoint for viewing sync audit logs",
      "✅ npm scripts for manual sync operations (sync:all, sync:users, etc.)",
      "✅ PeSKAS API metadata integration: Enhanced Data Download UX with field descriptions",
      "✅ Hybrid UX pattern: Column info icons + Data Dictionary modal",
      "✅ Lazy loading with sessionStorage caching (1s first load, instant after)",
      "✅ Conditional modal behavior: Single field view vs all fields view",
      "✅ Comprehensive field documentation: description, unit, examples, ranges, URLs",
      "✅ TypeScript interfaces matching PeSKAS API schema (FieldDescription, FieldMetadata)",
      "✅ Full i18n support (en, pt, sw) for metadata UI",
      "✅ Backend endpoint: api/data-download/metadata-fields.js with graceful degradation",
      "✅ Frontend components: FieldInfoIcon.tsx, FieldMetadataModal.tsx",
      "✅ User feedback iterations: Fixed URL fields, removed type column, correct field names, single-field modal",
      "✅ Followed AlertGuideModal pattern for consistency",
      "✅ Non-intrusive implementation (doesn't slow preview)"
    ],
    "pending_todos": []
  },
  "token_optimization_notes": [
    "Reference docs/ folder by link, don't read entire files unless needed",
    "Use grep to find patterns instead of reading multiple files",
    "Check .claude/skills/ for established patterns before researching",
    "CLAUDE.md contains architecture overview - reference it, don't duplicate",
    "Read .claude/memory/architecture-decisions.md first to understand recent changes",
    "Use agents for delegated tasks instead of loading full context",
    "Password reset pattern documented - reference architecture-decisions.md instead of re-reading implementation",
    "PeSKAS API integration documented - reference architecture-decisions.md for external API client pattern, permission filtering, preview-before-download UX",
    "Data download refactoring documented (2026-01-25) - reference for: shared permission utilities pattern, unified metadata endpoint pattern, Airtable→MongoDB migration pattern, input validation pattern, CSV sanitization pattern",
    "Airtable hardening documented (2026-01-26) - reference for: field mapping configuration, schema validation, transaction-like safety, audit logging, rate limiting, distributed locks, automated syncs, webhook integration",
    "Performance optimization documented (2026-01-27) - reference PERFORMANCE_IMPROVEMENTS.md and architecture-decisions.md for: database indexing pattern, survey-based loading, MongoDB-level pagination, batched API responses, optimistic updates, React.memo with custom comparison, useMemo for expensive operations",
    "PeSKAS API metadata integration documented (2026-01-27) - reference architecture-decisions.md for: lazy loading with sessionStorage caching pattern, conditional modal behavior (single field vs all fields), TanStack Table column enhancement with info icons, useFetchFieldMetadata hook pattern, comprehensive field documentation display (description, unit, examples, ranges, URLs)"
  ],
  "common_patterns": {
    "api_endpoint": "Use lib/response.js (sendSuccess, sendError, sendBadRequest, setCorsHeaders), lib/middleware.js, lib/db.js",
    "react_component": "Functional components with TypeScript, use Tabler UI classes",
    "state_management": "Custom hooks pattern (see src/api/api.ts)",
    "database_query": "Always validate ObjectIds, use projection, check permissions, apply .limit() at MongoDB level (not after .toArray())",
    "ui_implementation": "Check Tabler docs first at https://tabler.io/docs",
    "performance_indexing": "Use scripts/add_performance_indexes.cjs pattern: compound indexes (submission_date + submitted_by), background creation, idempotent checks",
    "survey_filtering": "Require survey_id parameter when user has multiple surveys, auto-select first survey in frontend",
    "mongodb_pagination": "Apply .limit() at MongoDB query level, cap at 10,000 per survey with warnings for larger requests",
    "api_batching": "Include related data in single response (e.g., alert_codes in metadata) to eliminate waterfall API calls",
    "optimistic_updates": "Use findOneAndUpdate with returnDocument:'after', return updated document, update local state immediately via callback",
    "react_memoization": "Use useMemo for expensive computations (data filtering, processing), only re-compute when dependencies change",
    "chart_optimization": "Wrap chart components in React.memo with custom deep comparison to prevent re-renders when data unchanged",
    "airtable_sync": "Production-hardened sync: config/airtable-field-mappings.json for field mappings, lib/field-mapper.js for validation, lib/sync-transaction.js for safety, lib/sync-audit-logger.js for logging, lib/sync-lock.js for concurrency control, scripts/sync_all_from_airtable.js for master sync",
    "field_mapping": "Use config/airtable-field-mappings.json + lib/field-mapper.js for centralized Airtable field mappings with fallbacks and validation",
    "sync_transaction": "Use lib/sync-transaction.js SyncTransaction.execute() for checkpoint/rollback safety in data sync operations",
    "audit_logging": "Use lib/sync-audit-logger.js SyncAuditLogger class with uuid sync_id for persistent MongoDB audit trails",
    "distributed_locks": "Use lib/sync-lock.js SyncLock.executeWithLock() for preventing concurrent operations (10-minute auto-expiry)",
    "rate_limiting_external": "Use lib/airtable-rate-limiter.js for Airtable API (5 req/sec + exponential backoff), lib/rate-limit.js for app rate limiting",
    "email_sending": "Use lib/email.js for AWS SES with multi-language templates",
    "password_reset": "Three-endpoint pattern: forgot-password → validate-reset-token → reset-password",
    "external_api_client": "Use lib/peskas-api.js pattern: rate limiting, custom error class, authentication headers, input validation",
    "data_download": "Preview-before-download UX: preview endpoint (20 rows + count) → user reviews → export endpoint (full CSV)",
    "permission_filtering": "Use lib/filter-permissions.js (getAccessibleCountries, getAccessibleSurveys, getAccessibleDistricts, applyDownloadPermissions) - single source of truth",
    "unified_metadata": "Single endpoint pattern: /api/{feature}/metadata returns all filter options in one request (see api/data-download/metadata.js)",
    "input_validation": "Validate all external API parameters with regex patterns before sending (see lib/peskas-api.js validateFilters)",
    "csv_export": "Use lib/helpers.js sanitizeCSV() to prevent formula injection in CSV exports",
    "field_metadata_display": "Use lazy loading + sessionStorage caching pattern for external API metadata (see useFetchFieldMetadata hook in src/api/api.ts)",
    "conditional_modal": "Implement single-item vs all-items modal behavior with highlightField prop (see FieldMetadataModal.tsx)",
    "column_info_icons": "Enhance TanStack Table headers with info icons for contextual help (see DataPreview.tsx column definitions)",
    "peskas_metadata": "Use api/data-download/metadata-fields.js for authenticated PeSKAS API metadata access with graceful degradation"
  },
  "management_scripts": {
    "master_sync": "scripts/sync_all_from_airtable.js - Master sync enforcing dependency order (Districts → Surveys → Users) with lib/sync-transaction.js safety",
    "user_sync": "scripts/sync_users_from_airtable.js - Sync users from Airtable (uses lib/airtable-sync-users.js canonical implementation)",
    "survey_sync": "scripts/sync_surveys_from_airtable.js - Sync survey metadata from Airtable with schema validation",
    "district_sync": "scripts/sync_districts_from_airtable.cjs - Sync districts (GAUL codes) from Airtable to MongoDB with schema validation",
    "user_creation": "scripts/create_first_admin.js - Create initial admin user",
    "password_reset_setup": "scripts/prepare_password_reset.js - Database migration for password reset feature",
    "npm_scripts": "npm run sync:all (master sync), sync:users, sync:surveys, sync:districts (individual syncs)",
    "automation": "Vercel cron job (daily 2 AM UTC) via api/admin/cron-sync-all.js, optional webhooks via api/webhooks/airtable-sync.js",
    "monitoring": "GET api/admin/sync-logs for viewing audit logs (pagination, filtering by entity_type)",
    "note": "Production-hardened sync infrastructure (8/10 readiness): field mapping config, schema validation, transaction safety, audit logging, rate limiting, distributed locks, automated cron, webhook support"
  },
  "security_patterns": {
    "email_enumeration_prevention": "Always return success message, never reveal if user exists",
    "rate_limiting": "Dual limits (IP + user) to prevent brute force attacks",
    "token_security": "crypto.randomBytes(32) for 64-char hex tokens, 1-hour expiry, one-time use",
    "password_hashing": "bcrypt with 10 salt rounds",
    "cors": "setCorsHeaders(res, req) from lib/response.js - REQUIRED for all API endpoints",
    "input_validation": "Validate all external API parameters with regex patterns (country, status, scope, catch_taxon, survey_id, gaul_2) - see lib/peskas-api.js",
    "csv_sanitization": "Use lib/helpers.js sanitizeCSV() to prevent formula injection (=, +, -, @, tab, carriage return)",
    "permission_enforcement": "Server-side only via lib/filter-permissions.js - never trust client-side filtering"
  }
}
